rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is a room participant
    function isParticipant(roomId, userId) {
      let room = get(/databases/$(database)/documents/rooms/$(roomId));
      return userId in room.data.participants[].userId;
    }
    
    // Rooms collection
    match /rooms/{roomId} {
      // Allow read if user is a participant or if checking room existence (for join flow)
      allow read: if request.auth != null && (
        request.auth.uid in resource.data.participants.map(p => p.userId) ||
        // Allow reading for join validation
        true
      );
      
      // Allow create for authenticated users
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.createdBy &&
        request.resource.data.status == 'active' &&
        request.resource.data.participants.size() == 1 &&
        request.resource.data.participants[0].userId == request.auth.uid;
      
      // Allow update if user is a participant
      allow update: if request.auth != null &&
        request.auth.uid in resource.data.participants.map(p => p.userId);
      
      // Allow delete if user is the creator
      allow delete: if request.auth != null && request.auth.uid == resource.data.createdBy;
      
      // Items subcollection
      match /items/{itemId} {
        // Allow read for room participants
        allow read: if request.auth != null &&
          request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomId)).data.participants.map(p => p.userId);
        
        // Allow create for room participants
        allow create: if request.auth != null &&
          request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomId)).data.participants.map(p => p.userId) &&
          request.resource.data.addedBy == request.auth.uid;
        
        // Allow update for room participants (for item selection)
        allow update: if request.auth != null &&
          request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomId)).data.participants.map(p => p.userId);
        
        // Allow delete for item creator or room creator
        allow delete: if request.auth != null && (
          request.auth.uid == resource.data.addedBy ||
          request.auth.uid == get(/databases/$(database)/documents/rooms/$(roomId)).data.createdBy
        );
      }
    }
  }
}
